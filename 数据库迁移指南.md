# 数据库迁移指南

## 🎯 迁移场景

当你需要重新部署系统或迁移到新服务器时，可以使用数据库导入导出功能来保留所有数据。

## 📋 迁移步骤

### 1. 导出当前数据库（在旧服务器上）

```bash
# 导出数据库（包含结构和数据）
./deploy.sh export-db
```

这将会：
- 导出完整的数据库结构和数据
- 保存到 `backups/database_export_YYYYMMDD_HHMMSS.sql.gz`
- 自动压缩文件以节省空间

### 2. 重新部署系统

```bash
# 完全重新部署
./deploy.sh first-deploy

# 或者分步部署
./deploy.sh install-db      # 安装PostgreSQL
./deploy.sh install-backend # 安装后端依赖
./deploy.sh install-frontend # 安装前端依赖
```

### 3. 导入数据库（在新服务器上）

```bash
# 导入之前导出的数据库
./deploy.sh import-db
```

这将会：
- 自动查找最新的导出文件
- 解压并导入数据库
- 验证导入结果
- 清理临时文件

## 🔧 命令详解

### export-db（导出数据库）
- **功能**：导出完整的数据库结构和数据
- **文件格式**：`.sql.gz`（压缩的SQL文件）
- **包含内容**：表结构、数据、索引、约束等
- **用途**：完整迁移、备份、版本控制

### import-db（导入数据库）
- **功能**：从导出文件导入数据库
- **自动查找**：自动选择最新的导出文件
- **安全验证**：导入后验证数据库完整性
- **用途**：恢复数据、迁移到新环境

### backup-db（备份数据库）
- **功能**：仅备份数据，不包含表结构
- **文件格式**：`.sql.gz`（压缩的SQL文件）
- **包含内容**：仅数据，不含DROP/CREATE语句
- **用途**：日常备份、数据恢复

## 📁 文件位置

```
project-fince/
├── backups/                    # 备份目录
│   ├── database_export_*.sql.gz  # 完整导出文件
│   └── database_backup_*.sql.gz  # 数据备份文件
├── temp/                       # 临时目录
│   └── temp_import.sql        # 导入时的临时文件
└── deploy.sh                   # 部署脚本
```

## ⚠️ 注意事项

### 导出前检查
- 确保PostgreSQL服务正在运行
- 确保有足够的磁盘空间
- 建议在系统负载较低时执行

### 导入前检查
- 确保PostgreSQL服务正在运行
- 确保目标服务器有足够的资源
- 建议先备份目标数据库（如果存在）

### 文件管理
- 导出文件会自动压缩以节省空间
- 建议定期清理旧的备份文件
- 重要数据建议异地备份

## 🚀 快速迁移流程

```bash
# 1. 在旧服务器上导出数据库
./deploy.sh export-db

# 2. 将导出文件传输到新服务器
scp backups/database_export_*.sql.gz user@new-server:/path/to/project-fince/backups/

# 3. 在新服务器上重新部署
./deploy.sh first-deploy

# 4. 导入数据库
./deploy.sh import-db

# 5. 验证系统
./deploy.sh health
```

## 🔍 故障排除

### 导出失败
- 检查PostgreSQL服务状态
- 检查数据库用户权限
- 检查磁盘空间

### 导入失败
- 检查导出文件完整性
- 检查PostgreSQL版本兼容性
- 检查目标数据库权限

### 验证失败
- 手动检查数据库连接
- 检查表结构完整性
- 查看导入日志

## 💡 最佳实践

1. **定期导出**：建议每周导出一次数据库
2. **版本管理**：保留多个版本的导出文件
3. **测试导入**：在生产环境导入前先在测试环境验证
4. **监控空间**：定期清理旧的备份文件
5. **异地备份**：重要数据建议异地存储

---
创建时间：2025年1月26日  
版本：v1.0  
状态：✅ 完成
