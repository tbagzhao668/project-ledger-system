# å·¥ç¨‹é¡¹ç›®æµæ°´è´¦ç³»ç»Ÿ - Dockeréƒ¨ç½²æŒ‡å—

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®å·²å®Œå…¨DockeråŒ–ï¼Œæ”¯æŒç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ï¼ŒåŒ…å«HTTPSè®¿é—®å’Œå®Œæ•´çš„æœåŠ¡ç¼–æ’ã€‚

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Nginx (443)   â”‚    â”‚   Frontend      â”‚    â”‚   Backend API   â”‚
â”‚   HTTPSä»£ç†     â”‚â—„â”€â”€â–ºâ”‚   Vue.js        â”‚â—„â”€â”€â–ºâ”‚   FastAPI       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PostgreSQL    â”‚    â”‚   Redis         â”‚    â”‚   Celery        â”‚
â”‚   æ•°æ®åº“        â”‚    â”‚   ç¼“å­˜          â”‚    â”‚   å¼‚æ­¥ä»»åŠ¡      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒè¦æ±‚

- Docker 20.10+
- Docker Compose 2.0+
- åŸŸåï¼ˆç”¨äºHTTPSè¯ä¹¦ï¼‰
- 80å’Œ443ç«¯å£å¼€æ”¾

### 2. å…‹éš†é¡¹ç›®

```bash
git clone <your-repo-url>
cd å·¥ç¨‹é¡¹ç›®æµæ°´è´¦
```

### 3. é…ç½®åŸŸå

ç¼–è¾‘ `nginx/conf.d/default.conf` æ–‡ä»¶ï¼Œå°† `yourdomain.com` æ›¿æ¢ä¸ºæ‚¨çš„å®é™…åŸŸåã€‚

### 4. è·å–SSLè¯ä¹¦

```bash
./setup-ssl.sh yourdomain.com admin@yourdomain.com
```

### 5. éƒ¨ç½²ç³»ç»Ÿ

```bash
./deploy.sh
```

## ğŸ“‹ æœåŠ¡é…ç½®

### æ•°æ®åº“é…ç½®

- **ç”¨æˆ·**: `gcxm_admin`
- **å¯†ç **: `ADS@gcxm#@%`
- **æ•°æ®åº“**: `project_ledger`
- **ç«¯å£**: `5432` (ä»…æœ¬åœ°è®¿é—®)

### Redisé…ç½®

- **å¯†ç **: `ADS@gcxm#@%`
- **ç«¯å£**: `6379` (ä»…æœ¬åœ°è®¿é—®)

### åº”ç”¨é…ç½®

- **åç«¯API**: å®¹å™¨å†…8000ç«¯å£
- **å‰ç«¯**: å®¹å™¨å†…80ç«¯å£
- **Nginx**: 80å’Œ443ç«¯å£ï¼ˆå…¬ç½‘è®¿é—®ï¼‰

## ğŸ”§ ç¯å¢ƒå˜é‡

ä¸»è¦ç¯å¢ƒå˜é‡åœ¨ `env.production` æ–‡ä»¶ä¸­é…ç½®ï¼š

```bash
# æ•°æ®åº“è¿æ¥
DATABASE_URL=postgresql+asyncpg://gcxm_admin:ADS%40gcxm%23%40%25@postgres:5432/project_ledger

# Redisè¿æ¥
REDIS_URL=redis://:ADS%40gcxm%23%40%25@redis:6379/0

# åº”ç”¨é…ç½®
ENVIRONMENT=production
DEBUG=false
```

## ğŸ“ ç›®å½•ç»“æ„

```
å·¥ç¨‹é¡¹ç›®æµæ°´è´¦/
â”œâ”€â”€ docker-compose.prod.yml    # ç”Ÿäº§ç¯å¢ƒç¼–æ’æ–‡ä»¶
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ Dockerfile.prod        # åç«¯ç”Ÿäº§é•œåƒ
â”‚   â””â”€â”€ ...
â”œâ”€â”€ frontend-new/
â”‚   â”œâ”€â”€ Dockerfile.prod        # å‰ç«¯ç”Ÿäº§é•œåƒ
â”‚   â””â”€â”€ ...
â”œâ”€â”€ nginx/
â”‚   â”œâ”€â”€ nginx.conf             # ä¸»é…ç½®
â”‚   â”œâ”€â”€ conf.d/                # ç«™ç‚¹é…ç½®
â”‚   â”œâ”€â”€ ssl/                   # SSLè¯ä¹¦
â”‚   â””â”€â”€ logs/                  # æ—¥å¿—æ–‡ä»¶
â”œâ”€â”€ deploy.sh                  # éƒ¨ç½²è„šæœ¬
â”œâ”€â”€ setup-ssl.sh              # SSLè¯ä¹¦é…ç½®
â”œâ”€â”€ renew-ssl.sh              # è¯ä¹¦ç»­æœŸ
â””â”€â”€ env.production            # ç¯å¢ƒå˜é‡
```

## ğŸ› ï¸ ç®¡ç†å‘½ä»¤

### å¯åŠ¨æœåŠ¡

```bash
docker-compose -f docker-compose.prod.yml up -d
```

### åœæ­¢æœåŠ¡

```bash
docker-compose -f docker-compose.prod.yml down
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f backend
```

### é‡å¯æœåŠ¡

```bash
docker-compose -f docker-compose.prod.yml restart [æœåŠ¡å]
```

### æ›´æ–°æœåŠ¡

```bash
# é‡æ–°æ„å»ºå¹¶å¯åŠ¨
docker-compose -f docker-compose.prod.yml up -d --build

# ä»…æ›´æ–°ç‰¹å®šæœåŠ¡
docker-compose -f docker-compose.prod.yml up -d --build backend
```

## ğŸ” SSLè¯ä¹¦ç®¡ç†

### è‡ªåŠ¨ç»­æœŸ

è®¾ç½®cronä»»åŠ¡ï¼Œæ¯60å¤©è‡ªåŠ¨ç»­æœŸï¼š

```bash
# ç¼–è¾‘crontab
crontab -e

# æ·»åŠ ä»¥ä¸‹è¡Œï¼ˆæ›¿æ¢ä¸ºå®é™…è·¯å¾„ï¼‰
0 0 1 */2 * /path/to/your/project/renew-ssl.sh
```

### æ‰‹åŠ¨ç»­æœŸ

```bash
./renew-ssl.sh
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### å¥åº·æ£€æŸ¥

- **å‰ç«¯**: `https://yourdomain.com/health`
- **åç«¯**: `https://yourdomain.com/api/health`
- **æ•°æ®åº“**: å®¹å™¨å†…å¥åº·æ£€æŸ¥
- **Redis**: å®¹å™¨å†…å¥åº·æ£€æŸ¥

### æ—¥å¿—ä½ç½®

- **Nginx**: `nginx/logs/`
- **åº”ç”¨**: `logs/`
- **å®¹å™¨**: `docker-compose -f docker-compose.prod.yml logs`

## ğŸ”’ å®‰å…¨é…ç½®

### ç½‘ç»œå®‰å…¨

- æ•°æ®åº“å’ŒRedisä»…é™æœ¬åœ°è®¿é—®
- æ‰€æœ‰å¤–éƒ¨æµé‡é€šè¿‡Nginxä»£ç†
- å¯ç”¨HSTSå®‰å…¨å¤´
- é…ç½®CORSç­–ç•¥

### æ–‡ä»¶æƒé™

```bash
chmod 755 uploads logs
chmod 700 nginx/ssl
```

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ç«¯å£å†²çª**: æ£€æŸ¥80å’Œ443ç«¯å£æ˜¯å¦è¢«å ç”¨
2. **è¯ä¹¦é—®é¢˜**: ç¡®ä¿åŸŸåè§£ææ­£ç¡®ï¼Œ80ç«¯å£å¼€æ”¾
3. **æ•°æ®åº“è¿æ¥**: æ£€æŸ¥å®¹å™¨ç½‘ç»œå’Œæ•°æ®åº“çŠ¶æ€
4. **æƒé™é—®é¢˜**: ç¡®ä¿ç›®å½•æƒé™æ­£ç¡®è®¾ç½®

### è°ƒè¯•å‘½ä»¤

```bash
# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps

# æ£€æŸ¥ç½‘ç»œ
docker network ls
docker network inspect project_ledger_project_ledger_network

# è¿›å…¥å®¹å™¨è°ƒè¯•
docker-compose -f docker-compose.prod.yml exec backend bash
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### ç”Ÿäº§ç¯å¢ƒå»ºè®®

- ä½¿ç”¨å¤šworkerè¿›ç¨‹ï¼ˆå·²é…ç½®4ä¸ªï¼‰
- å¯ç”¨Gzipå‹ç¼©
- é…ç½®é™æ€èµ„æºç¼“å­˜
- ä½¿ç”¨è¿æ¥æ± 
- ç›‘æ§èµ„æºä½¿ç”¨

### æ‰©å±•é…ç½®

```yaml
# åœ¨docker-compose.prod.ymlä¸­æ·»åŠ 
deploy:
  replicas: 3  # æ‰©å±•åç«¯æœåŠ¡
  resources:
    limits:
      cpus: '2'
      memory: 2G
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š

1. Dockerå’ŒDocker Composeç‰ˆæœ¬
2. ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ
3. ç½‘ç»œå’Œé˜²ç«å¢™é…ç½®
4. æ—¥å¿—æ–‡ä»¶å†…å®¹

---

**æ³¨æ„**: ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰ï¼Œè¯·åŠ¡å¿…ï¼š
- ä¿®æ”¹é»˜è®¤å¯†ç å’Œå¯†é’¥
- é…ç½®å¤‡ä»½ç­–ç•¥
- è®¾ç½®ç›‘æ§å‘Šè­¦
- æµ‹è¯•æ•…éšœæ¢å¤æµç¨‹
