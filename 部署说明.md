# 工程项目流水账管理系统 - 本地部署说明

## 系统概述

工程项目流水账管理系统是一个基于Python FastAPI + PostgreSQL + Vue.js的多租户SaaS系统，支持项目管理、财务记录、权限管理、报表分析等功能。

## 技术架构

- **后端**: Python FastAPI + SQLAlchemy + Alembic
- **数据库**: PostgreSQL 16
- **缓存**: Redis
- **异步任务**: Celery
- **前端**: Vue.js 3 + Vite
- **Web服务器**: Nginx
- **部署方式**: 本地部署（非Docker）

## 系统要求

- **操作系统**: Ubuntu 20.04+ / CentOS 7+ / Debian 10+
- **Python**: 3.8+
- **Node.js**: 16+
- **内存**: 最少4GB，推荐8GB+
- **存储**: 最少20GB可用空间
- **端口**: 80 (HTTP), 8000 (API), 5432 (PostgreSQL), 6379 (Redis)

## 快速启动

### 1. 一键启动所有服务

```bash
# 给脚本执行权限（首次运行）
chmod +x start-services.sh stop-services.sh

# 启动所有服务
./start-services.sh
```

### 2. 停止所有服务

```bash
./stop-services.sh
```

## 手动部署步骤

### 1. 安装系统依赖

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install -y python3 python3-pip python3-venv nodejs npm postgresql postgresql-contrib redis-server nginx

# CentOS/RHEL
sudo yum install -y python3 python3-pip python3-venv nodejs npm postgresql postgresql-server redis nginx
```

### 2. 配置PostgreSQL

```bash
# 启动PostgreSQL服务
sudo systemctl start postgresql
sudo systemctl enable postgresql

# 创建数据库和用户
sudo -u postgres psql -c "CREATE DATABASE project_ledger;"
sudo -u postgres psql -c "ALTER USER postgres PASSWORD '123456';"
```

### 3. 配置Redis

```bash
# 启动Redis服务
sudo systemctl start redis-server
sudo systemctl enable redis-server

# 检查Redis状态
redis-cli ping
```

### 4. 部署后端

```bash
cd backend

# 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 配置数据库连接
# 修改 app/config.py 中的数据库URL

# 运行数据库迁移
alembic stamp head

# 启动后端服务
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

### 5. 启动Celery工作进程

```bash
cd backend
source venv/bin/activate

# 启动Celery工作进程
celery -A app.core.celery_app worker --loglevel=info
```

### 6. 配置Nginx

```bash
# 复制配置文件
sudo cp nginx/nginx-local.conf /etc/nginx/nginx.conf

# 测试配置
sudo nginx -t

# 启动Nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

### 7. 部署前端

```bash
cd frontend

# 安装依赖
npm install

# 构建生产版本
npm run build

# 前端文件将生成在 dist/ 目录
```

## 服务管理

### 检查服务状态

```bash
# 检查系统服务
sudo systemctl status postgresql
sudo systemctl status redis-server
sudo systemctl status nginx

# 检查应用进程
ps aux | grep -E "(uvicorn|celery|nginx|postgres|redis)" | grep -v grep
```

### 查看日志

```bash
# 后端日志
tail -f backend/logs/uvicorn.log
tail -f backend/logs/celery.log

# Nginx日志
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log

# 系统服务日志
sudo journalctl -u postgresql -f
sudo journalctl -u redis-server -f
sudo journalctl -u nginx -f
```

### 重启服务

```bash
# 重启系统服务
sudo systemctl restart postgresql
sudo systemctl restart redis-server
sudo systemctl restart nginx

# 重启应用进程
# 使用 stop-services.sh 和 start-services.sh 脚本
```

## 配置说明

### 环境变量配置

创建 `.env` 文件在 `backend/` 目录：

```bash
# 数据库配置
DATABASE_URL=postgresql+asyncpg://postgres:123456@localhost:5432/project_ledger
DATABASE_URL_SYNC=postgresql://postgres:123456@localhost:5432/project_ledger

# Redis配置
REDIS_URL=redis://localhost:6379/0

# JWT配置
SECRET_KEY=your-super-secret-key-change-this-in-production
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=1440
REFRESH_TOKEN_EXPIRE_DAYS=30

# 文件上传配置
UPLOAD_DIR=uploads
MAX_FILE_SIZE=52428800
```

### Nginx配置

主要配置项说明：

- **前端静态文件**: 服务 `/home/dev/工程项目流水账/frontend/dist` 目录
- **API代理**: 将 `/api/` 请求代理到后端 `http://127.0.0.1:8000/`
- **文件上传**: 服务 `/home/dev/工程项目流水账/uploads/` 目录
- **Gzip压缩**: 启用静态资源压缩
- **缓存策略**: 静态资源长期缓存，API请求不缓存

### 数据库配置

PostgreSQL主要配置：

- **数据库名**: `project_ledger`
- **用户名**: `postgres`
- **密码**: `123456`
- **端口**: `5432`
- **字符集**: `UTF8`

## 访问地址

- **前端应用**: http://localhost
- **后端API**: http://localhost:8000
- **API文档**: http://localhost:8000/docs
- **健康检查**: http://localhost/health

## 故障排除

### 常见问题

1. **端口被占用**
   ```bash
   # 查看端口占用
   sudo netstat -tlnp | grep :8000
   sudo netstat -tlnp | grep :80
   
   # 杀死占用进程
   sudo kill -9 <PID>
   ```

2. **数据库连接失败**
   ```bash
   # 检查PostgreSQL状态
   sudo systemctl status postgresql
   
   # 检查数据库连接
   sudo -u postgres psql -c "SELECT version();"
   ```

3. **权限问题**
   ```bash
   # 检查目录权限
   ls -la /home/dev/工程项目流水账/
   
   # 修复权限
   sudo chown -R dev:dev /home/dev/工程项目流水账/
   ```

4. **Nginx配置错误**
   ```bash
   # 测试配置
   sudo nginx -t
   
   # 查看错误日志
   sudo tail -f /var/log/nginx/error.log
   ```

### 性能优化

1. **数据库优化**
   - 调整PostgreSQL内存参数
   - 创建必要的索引
   - 定期VACUUM和ANALYZE

2. **Redis优化**
   - 配置内存限制
   - 启用持久化
   - 设置合理的过期策略

3. **Nginx优化**
   - 调整worker进程数
   - 启用HTTP/2
   - 配置静态文件缓存

## 备份和恢复

### 数据库备份

```bash
# 创建备份
pg_dump -h localhost -U postgres project_ledger > backup_$(date +%Y%m%d_%H%M%S).sql

# 恢复备份
psql -h localhost -U postgres project_ledger < backup_file.sql
```

### 文件备份

```bash
# 备份上传文件
tar -czf uploads_backup_$(date +%Y%m%d_%H%M%S).tar.gz uploads/

# 备份日志文件
tar -czf logs_backup_$(date +%Y%m%d_%H%M%S).tar.gz backend/logs/
```

## 安全建议

1. **修改默认密码**
   - 更改PostgreSQL默认密码
   - 更改Redis密码（如需要）
   - 使用强密码策略

2. **防火墙配置**
   ```bash
   # 只开放必要端口
   sudo ufw allow 80/tcp
   sudo ufw allow 22/tcp
   sudo ufw enable
   ```

3. **SSL/TLS配置**
   - 申请SSL证书
   - 配置HTTPS
   - 强制HTTPS重定向

4. **定期更新**
   - 系统安全更新
   - 依赖包更新
   - 安全补丁应用

## 监控和维护

### 系统监控

```bash
# 系统资源监控
htop
iotop
nethogs

# 服务状态监控
systemctl list-units --type=service --state=running
```

### 日志轮转

配置logrotate防止日志文件过大：

```bash
# 编辑 /etc/logrotate.d/nginx
/home/dev/工程项目流水账/backend/logs/*.log {
    daily
    missingok
    rotate 7
    compress
    delaycompress
    notifempty
    create 644 dev dev
}
```

## 联系支持

如遇到问题，请检查：

1. 系统日志
2. 应用日志
3. 服务状态
4. 网络连接
5. 文件权限

---

**注意**: 本系统仅供内部使用，请勿在生产环境中使用默认密码和配置。
