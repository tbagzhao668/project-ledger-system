# 新服务器完整部署脚本

## 🎯 服务器信息
- **IP地址**: 192.168.1.215
- **用户名**: dev
- **密码**: 123
- **系统**: Ubuntu (全新)

## 📋 部署步骤清单

### 第1步：连接服务器并检查系统
```bash
# 连接到服务器
ssh dev@192.168.1.215

# 检查系统信息
whoami
pwd
uname -a
df -h
free -h
```

### 第2步：更新系统并安装基础工具
```bash
# 更新系统包
sudo apt update && sudo apt upgrade -y

# 安装基础工具
sudo apt install -y curl wget git vim htop tree unzip

# 安装Python 3.11和相关工具
sudo apt install -y python3.11 python3.11-venv python3.11-dev python3-pip

# 设置Python3.11为默认python3
sudo update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 1
```

### 第3步：安装Docker和Docker Compose
```bash
# 安装Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 将用户添加到docker组
sudo usermod -aG docker $USER

# 安装Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 验证安装
docker --version
docker-compose --version
```

### 第4步：安装PostgreSQL和Redis
```bash
# 安装PostgreSQL
sudo apt install -y postgresql postgresql-contrib

# 启动PostgreSQL服务
sudo systemctl start postgresql
sudo systemctl enable postgresql

# 设置PostgreSQL密码
sudo -u postgres psql -c "ALTER USER postgres PASSWORD '123456';"

# 创建数据库
sudo -u postgres createdb project_ledger

# 安装Redis
sudo apt install -y redis-server

# 启动Redis服务
sudo systemctl start redis-server
sudo systemctl enable redis-server
```

### 第5步：创建项目目录并上传代码
```bash
# 创建项目目录
mkdir -p /home/dev/project-ledger
cd /home/dev/project-ledger

# 创建必要的子目录
mkdir -p backend frontend logs uploads
```

**在本地机器上执行以下命令上传代码：**
```powershell
# 打包完整项目代码
tar -czf project-complete.tar.gz --exclude=.git --exclude=node_modules --exclude=__pycache__ --exclude=*.pyc --exclude=venv --exclude=*.tar.gz .

# 上传到服务器
scp project-complete.tar.gz dev@192.168.1.215:~/

# SSH到服务器解压
ssh dev@192.168.1.215
cd /home/dev/project-ledger
tar -xzf ~/project-complete.tar.gz
```

### 第6步：设置后端环境
```bash
cd /home/dev/project-ledger/backend

# 创建Python虚拟环境
python3 -m venv venv
source venv/bin/activate

# 升级pip
pip install --upgrade pip

# 安装Python依赖
pip install -r requirements.txt

# 创建环境配置文件
cat > .env << EOF
APP_NAME=工程项目流水账管理系统
DEBUG=true
DATABASE_URL=postgresql+asyncpg://postgres:123456@localhost:5432/project_ledger
DATABASE_URL_SYNC=postgresql://postgres:123456@localhost:5432/project_ledger
REDIS_URL=redis://localhost:6379/0
SECRET_KEY=your-secret-key-here-change-in-production
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30
REFRESH_TOKEN_EXPIRE_DAYS=7
ENCRYPTION_KEY=your-encryption-key-here
UPLOAD_DIR=/home/dev/project-ledger/uploads
EOF
```

### 第7步：初始化数据库
```bash
# 在backend目录下
cd /home/dev/project-ledger/backend
source venv/bin/activate

# 运行数据库迁移
alembic upgrade head

# 验证数据库表创建
python3 -c "
import asyncio
from sqlalchemy import text
from app.core.database import database_manager

async def check_tables():
    async with database_manager.get_session() as session:
        result = await session.execute(text('SELECT tablename FROM pg_tables WHERE schemaname = \\'public\\';'))
        tables = result.fetchall()
        print('Created tables:', [table[0] for table in tables])

asyncio.run(check_tables())
"
```

### 第8步：启动API服务器
```bash
cd /home/dev/project-ledger/backend
source venv/bin/activate

# 前台启动测试（确保没有错误）
uvicorn app.main:app --host 0.0.0.0 --port 8000

# 如果没有错误，停止并后台启动
# Ctrl+C 停止
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload > ../logs/api.log 2>&1 &
```

### 第9步：验证服务
```bash
# 检查API服务状态
curl http://localhost:8000/health

# 检查API文档
curl http://localhost:8000/docs

# 从外部访问测试
curl http://192.168.1.215:8000/health
```

### 第10步：设置防火墙（如果需要）
```bash
# 检查防火墙状态
sudo ufw status

# 如果防火墙开启，允许8000端口
sudo ufw allow 8000
sudo ufw allow ssh
```

## 🧪 完整API测试

### 测试1：注册租户
```bash
curl -X POST "http://192.168.1.215:8000/api/v1/auth/register" \
     -H "Content-Type: application/json" \
     -d '{
       "company_name": "测试建筑公司",
       "industry_type": "construction",
       "company_size": "small",
       "admin_name": "张三",
       "admin_email": "admin@test.com",
       "admin_phone": "13800138000",
       "password": "123456",
       "confirm_password": "123456"
     }'
```

### 测试2：管理员登录
```bash
curl -X POST "http://192.168.1.215:8000/api/v1/auth/login" \
     -H "Content-Type: application/json" \
     -d '{
       "email": "admin@test.com",
       "password": "123456"
     }'

# 保存返回的token
export TOKEN="your_access_token_here"
```

### 测试3：测试用户管理API
```bash
# 获取当前用户信息
curl -H "Authorization: Bearer $TOKEN" \
     "http://192.168.1.215:8000/api/v1/users/me"

# 创建新用户
curl -X POST "http://192.168.1.215:8000/api/v1/users/" \
     -H "Authorization: Bearer $TOKEN" \
     -H "Content-Type: application/json" \
     -d '{
       "username": "李四",
       "email": "lisi@test.com",
       "password": "123456",
       "role": "finance",
       "permissions": ["transaction_read", "transaction_create"],
       "is_active": true
     }'

# 获取用户列表
curl -H "Authorization: Bearer $TOKEN" \
     "http://192.168.1.215:8000/api/v1/users/"

# 获取用户统计
curl -H "Authorization: Bearer $TOKEN" \
     "http://192.168.1.215:8000/api/v1/users/statistics"
```

## 🔧 问题排查

### 常见问题和解决方案：

#### 1. PostgreSQL连接问题
```bash
# 检查PostgreSQL状态
sudo systemctl status postgresql

# 重启PostgreSQL
sudo systemctl restart postgresql

# 检查连接
psql postgresql://postgres:123456@localhost:5432/project_ledger -c "SELECT 1;"
```

#### 2. Python依赖安装问题
```bash
# 如果pip安装失败，尝试
pip install --upgrade pip setuptools wheel
pip install -r requirements.txt --no-cache-dir
```

#### 3. 权限问题
```bash
# 检查目录权限
ls -la /home/dev/project-ledger/
sudo chown -R dev:dev /home/dev/project-ledger/
```

#### 4. 端口占用问题
```bash
# 检查8000端口占用
netstat -tulpn | grep 8000
sudo lsof -i :8000

# 杀死占用进程
sudo kill -9 <PID>
```

#### 5. API启动错误
```bash
# 查看详细错误日志
cd /home/dev/project-ledger/backend
source venv/bin/activate
python -c "from app.main import app; print('Import successful')"

# 查看API日志
tail -f /home/dev/project-ledger/logs/api.log
```

## 📊 部署验证清单

- [ ] 服务器连接成功
- [ ] 系统更新完成
- [ ] Python 3.11安装成功
- [ ] Docker安装成功
- [ ] PostgreSQL安装并配置
- [ ] Redis安装并运行
- [ ] 项目代码上传成功
- [ ] 虚拟环境创建成功
- [ ] 依赖安装完成
- [ ] 数据库迁移成功
- [ ] API服务器启动成功
- [ ] 健康检查通过
- [ ] 租户注册测试通过
- [ ] 用户登录测试通过
- [ ] 用户管理API测试通过

## 🎯 部署完成标志

当所有测试通过后，您将有：
1. ✅ 完整的API服务器运行在 http://192.168.1.215:8000
2. ✅ 可访问的API文档 http://192.168.1.215:8000/docs
3. ✅ 完整的用户管理功能
4. ✅ 数据库和缓存正常工作
5. ✅ 为后续开发做好准备

让我们开始执行这个部署计划！
