# 🚀 新服务器手动部署指南

## 📋 服务器信息
- **IP**: 192.168.1.215
- **用户**: dev  
- **密码**: 123
- **系统**: Ubuntu (全新安装)

---

## 🏗️ 第一阶段：服务器基础环境准备

### 1. 连接到服务器
```bash
# 从本地机器连接
ssh dev@192.168.1.215
```

### 2. 执行服务器设置脚本
```bash
# 在服务器上创建并运行设置脚本
cat > setup-server.sh << 'EOF'
#!/bin/bash
set -e

echo "🚀 开始服务器环境设置..."

# 更新系统
sudo apt update -y && sudo apt upgrade -y

# 安装基础工具
sudo apt install -y curl wget git vim htop tree unzip build-essential software-properties-common

# 安装Python 3.11
sudo add-apt-repository ppa:deadsnakes/ppa -y
sudo apt update
sudo apt install -y python3.11 python3.11-venv python3.11-dev python3-pip
sudo update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 1

# 安装PostgreSQL
sudo apt install -y postgresql postgresql-contrib
sudo systemctl start postgresql
sudo systemctl enable postgresql
sudo -u postgres psql -c "ALTER USER postgres PASSWORD '123456';"
sudo -u postgres createdb project_ledger

# 安装Redis
sudo apt install -y redis-server
sudo systemctl start redis-server
sudo systemctl enable redis-server

# 创建项目目录
mkdir -p /home/dev/project-ledger/{backend,frontend,logs,uploads}

echo "✅ 服务器环境设置完成！"
EOF

# 给脚本执行权限并运行
chmod +x setup-server.sh
./setup-server.sh
```

---

## 📦 第二阶段：上传项目代码

### 1. 在本地机器上打包代码
```powershell
# 在 C:\Users\1\Desktop\工程项目流水账 目录下执行
tar -czf project-complete.tar.gz --exclude=.git --exclude=node_modules --exclude=__pycache__ --exclude=*.pyc --exclude=venv --exclude=*.tar.gz .
```

### 2. 上传到服务器
```powershell
# 上传代码包
scp project-complete.tar.gz dev@192.168.1.215:~/
```

### 3. 在服务器上解压代码
```bash
# 在服务器上执行
cd /home/dev/project-ledger
tar -xzf ~/project-complete.tar.gz

# 检查文件结构
ls -la
```

---

## 🐍 第三阶段：Python环境配置

### 1. 创建虚拟环境
```bash
cd /home/dev/project-ledger/backend
python3 -m venv venv
source venv/bin/activate

# 验证Python版本
python --version  # 应该显示Python 3.11.x
```

### 2. 创建环境配置文件
```bash
cat > .env << 'EOF'
APP_NAME=工程项目流水账管理系统
DEBUG=true
DATABASE_URL=postgresql+asyncpg://postgres:123456@localhost:5432/project_ledger
DATABASE_URL_SYNC=postgresql://postgres:123456@localhost:5432/project_ledger
REDIS_URL=redis://localhost:6379/0
SECRET_KEY=dev-secret-key-change-in-production-1234567890
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30
REFRESH_TOKEN_EXPIRE_DAYS=7
ENCRYPTION_KEY=dev-encryption-key-change-in-production
ENCRYPTION_SALT=dev-salt-change-in-production
UPLOAD_DIR=/home/dev/project-ledger/uploads
MAX_FILE_SIZE=10485760
LOG_LEVEL=INFO
LOG_FILE=/home/dev/project-ledger/logs/app.log
DEFAULT_STORAGE_LIMIT=5368709120
DEFAULT_API_CALLS_LIMIT=10000
EOF
```

### 3. 安装Python依赖
```bash
# 确保在虚拟环境中
source venv/bin/activate

# 升级pip
pip install --upgrade pip

# 安装依赖
pip install -r requirements.txt

# 如果遇到错误，逐个安装核心依赖
pip install fastapi uvicorn sqlalchemy asyncpg alembic python-jose[cryptography] passlib[bcrypt] python-multipart pydantic pydantic-settings
```

---

## 🗄️ 第四阶段：数据库初始化

### 1. 验证数据库连接
```bash
# 测试PostgreSQL连接
psql postgresql://postgres:123456@localhost:5432/project_ledger -c "SELECT 1;"
```

### 2. 运行数据库迁移
```bash
cd /home/dev/project-ledger/backend
source venv/bin/activate

# 运行迁移
alembic upgrade head

# 验证表创建
python3 -c "
import asyncio
from sqlalchemy import text
from app.core.database import database_manager

async def check_tables():
    async with database_manager.get_session() as session:
        result = await session.execute(text('SELECT tablename FROM pg_tables WHERE schemaname = \\'public\\';'))
        tables = result.fetchall()
        print('数据库表:', [table[0] for table in tables])

asyncio.run(check_tables())
"
```

---

## 🚀 第五阶段：启动API服务器

### 1. 测试启动
```bash
cd /home/dev/project-ledger/backend
source venv/bin/activate

# 前台启动测试
uvicorn app.main:app --host 0.0.0.0 --port 8000

# 如果启动成功，按Ctrl+C停止
```

### 2. 后台启动
```bash
# 后台启动API服务器
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload > ../logs/api.log 2>&1 &

# 检查进程
ps aux | grep uvicorn

# 查看日志
tail -f /home/dev/project-ledger/logs/api.log
```

---

## 🧪 第六阶段：功能测试

### 1. 基础健康检查
```bash
# 在服务器上测试
curl http://localhost:8000/health

# 从外部测试（在本地机器上）
curl http://192.168.1.215:8000/health
```

### 2. API文档检查
```bash
# 检查API文档
curl http://192.168.1.215:8000/docs
```

### 3. 租户注册测试
```bash
curl -X POST "http://192.168.1.215:8000/api/v1/auth/register" \
     -H "Content-Type: application/json" \
     -d '{
       "company_name": "测试建筑公司",
       "industry_type": "construction", 
       "company_size": "small",
       "admin_name": "张三",
       "admin_email": "admin@test.com",
       "admin_phone": "13800138000",
       "password": "123456",
       "confirm_password": "123456"
     }'
```

### 4. 登录测试
```bash
curl -X POST "http://192.168.1.215:8000/api/v1/auth/login" \
     -H "Content-Type: application/json" \
     -d '{
       "email": "admin@test.com",
       "password": "123456"
     }'

# 保存返回的access_token
```

### 5. 用户管理API测试
```bash
# 使用上面获得的token
TOKEN="your_access_token_here"

# 获取当前用户信息
curl -H "Authorization: Bearer $TOKEN" \
     "http://192.168.1.215:8000/api/v1/users/me"

# 获取用户列表
curl -H "Authorization: Bearer $TOKEN" \
     "http://192.168.1.215:8000/api/v1/users/"

# 创建新用户
curl -X POST "http://192.168.1.215:8000/api/v1/users/" \
     -H "Authorization: Bearer $TOKEN" \
     -H "Content-Type: application/json" \
     -d '{
       "username": "李四",
       "email": "lisi@test.com", 
       "password": "123456",
       "role": "finance",
       "permissions": ["transaction_read", "transaction_create"],
       "is_active": true
     }'

# 获取用户统计
curl -H "Authorization: Bearer $TOKEN" \
     "http://192.168.1.215:8000/api/v1/users/statistics"
```

---

## 🔧 故障排除

### 1. 服务检查命令
```bash
# 检查PostgreSQL状态
sudo systemctl status postgresql

# 检查Redis状态  
sudo systemctl status redis-server

# 检查端口占用
netstat -tulpn | grep 8000

# 检查API进程
ps aux | grep uvicorn
```

### 2. 日志查看
```bash
# API日志
tail -f /home/dev/project-ledger/logs/api.log

# PostgreSQL日志
sudo tail -f /var/log/postgresql/postgresql-*-main.log

# 系统日志
sudo journalctl -f
```

### 3. 常见问题解决
```bash
# 如果端口被占用
sudo lsof -i :8000
sudo kill -9 <PID>

# 如果数据库连接失败
sudo systemctl restart postgresql
psql postgresql://postgres:123456@localhost:5432/project_ledger -c "SELECT 1;"

# 如果Python依赖安装失败
pip install --upgrade pip setuptools wheel
pip install -r requirements.txt --no-cache-dir
```

---

## ✅ 部署成功验证清单

- [ ] 服务器连接成功
- [ ] Python 3.11安装完成
- [ ] PostgreSQL安装并配置
- [ ] Redis安装并运行
- [ ] 项目代码上传成功
- [ ] 虚拟环境创建成功
- [ ] 依赖安装完成
- [ ] 环境变量配置正确
- [ ] 数据库迁移成功
- [ ] API服务器启动成功
- [ ] 健康检查通过 ✅
- [ ] 租户注册成功 ✅
- [ ] 用户登录成功 ✅
- [ ] 用户管理API测试通过 ✅

## 🎯 部署完成标志

当所有测试通过时，您将拥有：

1. **完整的API服务**: http://192.168.1.215:8000
2. **API文档页面**: http://192.168.1.215:8000/docs  
3. **用户管理功能**: 完整的CRUD操作
4. **数据库和缓存**: PostgreSQL + Redis正常运行
5. **为下一阶段开发做好准备**: 项目管理API、财务记录API等

## 📞 需要帮助时

如果遇到任何问题，请：
1. 检查对应的日志文件
2. 确认服务状态
3. 验证网络连接
4. 联系技术支持

🎉 **部署成功后，您就有了一个完整可用的工程项目流水账管理系统后端服务！**
